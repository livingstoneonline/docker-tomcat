#!/usr/bin/execlineb -P
# -*- mode: sh -*-
# vi: set ft=sh:
with-contenv
multisubstitute
{
  import -i MYSQL_ROOT_USER
  import -i MYSQL_ROOT_PASSWORD
  import -i FEDORA_HOME
  import -i FEDORA_DB_NAME
  import -i FEDORA_DB_USER
  import -i FEDORA_DB_PASSWORD
  import -i FEDORA_IMPORT_DATA
  import -i FEDORA_REBUILD
}
background { s6-setuidgid mysql mysqld }
importas MYSQLD_PID !
foreground {
    loopwhilex -x 0
    redirfd -w 1 /dev/null
    redirfd -w 2 /dev/null
    mysql --protocol=socket -u ${MYSQL_ROOT_USER} --password=${MYSQL_ROOT_PASSWORD} -e "SELECT 1"
}
# Only create the database and user for Fedora if
# the database does not already exist.
foreground {
  if -n {
    redirfd -w 2 /dev/null
    mysql --user=${MYSQL_ROOT_USER} --password=${MYSQL_ROOT_PASSWORD}
          -e use ${FEDORA_DB_NAME}
    }
     redirfd -w 2 /dev/null
     mysql --user=${MYSQL_ROOT_USER} --password=${MYSQL_ROOT_PASSWORD}
           -e "CREATE USER '${FEDORA_DB_USER}'@'localhost' IDENTIFIED BY '${FEDORA_DB_PASSWORD}';
               CREATE DATABASE ${FEDORA_DB_NAME};
               GRANT ALL ON ${FEDORA_DB_NAME}.* TO '${FEDORA_DB_USER}'@'localhost';
               GRANT ALL ON ${FEDORA_DB_NAME}.* TO '${FEDORA_DB_USER}'@'%';
               FLUSH PRIVILEGES;"
}
# Import Fedora / Solr Data.
foreground {
  if { s6-test ${FEDORA_IMPORT_DATA} = "yes" }
     # Unpack Fedora data.
     foreground {
       ifelse { s6-test -e "/assets/fedora-data.tar.bz2" } {
         cd / pipeline -d { bzip2 -dc /assets/fedora-data.tar.bz2 } /bin/tar xvf -
       } echo "/assets/fedora-data.tar.bz2 is missing."
     }
     # Unpack Solr data.
     foreground {
       ifelse { s6-test -e "/assets/solr-data.tar.bz2" } {
          cd / pipeline -d { bzip2 -dc /assets/solr-data.tar.bz2 } /bin/tar xvf -
       } echo "/assets/solr-data.tar.bz2 is missing."
     }
     # Unpack database.
     foreground {
       ifelse { s6-test -e /assets/fedora3.sql.gz } {
         cd /assets gunzip fedora3.sql.gz
       } echo "No Fedora database dump to decompress."
     }
     foreground {
       ifelse { s6-test -e /assets/fedora3.sql } {
          redirfd -r 0 /assets/fedora3.sql
          mysql --user=$MYSQL_ROOT_USER --password="${MYSQL_ROOT_PASSWORD}" fedora3
       } echo "/assets/fedora3.sql is missing."
     }
}
# Rebuild database and index.
foreground {
  if { s6-test ${FEDORA_REBUILD} = "yes" }
     foreground {
       fedora-rebuild-database.sh
     } fedora-rebuild-ri.sh
}
foreground {
  chown -R tomcat:tomcat ${FEDORA_HOME} /opt/tomcat /opt/solr
}
foreground {
  kill -s TERM $MYSQLD_PID
} sleep 5
